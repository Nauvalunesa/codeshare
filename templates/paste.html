<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ paste.title }} - CodeShare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        pre[class*="language-"] {
            background: rgba(17, 24, 39, 0.8) !important;
            border-radius: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body class="text-white">
    <nav class="glass p-4 mb-8 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
            <a href="/" class="text-2xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">CodeShare</a>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <!-- Enhanced responsive search bar for paste page -->
                <div class="flex items-center w-full sm:w-auto relative">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Cari paste, username, bahasa..." 
                        class="bg-white/10 border border-white/20 rounded-full px-4 py-2 pr-10 text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent w-full sm:w-64 transition-all"
                    >
                    <button onclick="performSearch()" class="absolute right-2 bg-purple-500/20 hover:bg-purple-500/30 p-1.5 rounded-full text-sm transition-all">
                        🔍
                    </button>
                </div>
                <div class="flex flex-wrap justify-center gap-2 sm:gap-4">
                    <a href="/dashboard" class="hover:text-blue-300 px-3 py-1 rounded transition-colors text-sm">Dashboard</a>
                    <a href="/create" class="hover:text-blue-300 px-3 py-1 rounded transition-colors text-sm">Create</a>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded transition-colors text-sm">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4">
        <div class="glass rounded-lg p-4 sm:p-6 mb-6">
            <div class="flex flex-col lg:flex-row justify-between items-start mb-4 space-y-4 lg:space-y-0">
                <div class="flex-1">
                    <h1 class="text-2xl sm:text-3xl font-bold text-white mb-3">{{ paste.title }}</h1>
                    <div class="flex flex-wrap items-center gap-3 text-sm">
                        <div class="flex items-center gap-2">
                            {% if paste.author_profile_picture %}
                            <img src="{{ paste.author_profile_picture }}" alt="{{ paste.author_username }} profile picture" class="w-8 h-8 rounded-full object-cover">
                            {% else %}
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                                {{ paste.author_username[0].upper() }}
                            </div>
                            {% endif %}
                            <span class="text-blue-300 flex items-center gap-1">
                                {{ paste.author_username }}
                                {% if paste.author_is_verified %}
                                <span class="text-blue-400">✓</span>
                                {% endif %}
                                {% if paste.author_is_admin %}
                                <span class="text-red-400">👑</span>
                                {% endif %}
                            </span>
                            {% if paste.author_badge_details %}
                                {% for badge in paste.author_badge_details %}
                                <span class="user-badge badge-{{ badge.name }} text-xs">{{ badge.icon }}</span>
                                {% endfor %}
                            {% endif %}
                            <!-- Added follow button for paste author -->
                            {% if current_user and current_user.username != paste.author_username %}
                            <button id="followBtn" 
                                    onclick="toggleFollow('{{ paste.author_username }}')"
                                    class="px-3 py-1 rounded-lg text-xs font-medium transition-all hover:scale-105 focus:outline-none"
                                    data-following="false">
                                <span id="followText">Follow</span>
                            </button>
                            {% endif %}
                        </div>
                        <span class="text-gray-400">•</span>
                        <span class="text-gray-400">{{ paste.created_at[:19].replace('T', ' ') }}</span>
                        {% if paste.language != 'text' %}
                        <span class="bg-blue-600 px-2 py-1 rounded text-xs">{{ paste.language }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center text-gray-300">
                        <span class="text-sm">👁️ <span id="view-count">{{ paste.views or 0 }}</span> views</span>
                    </div>
                    <!-- Enhanced authorization check for edit/delete buttons -->
                    {% if current_user and (current_user.username == paste.author_username or current_user.is_admin) %}
                    <button onclick="editPaste()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-lg text-sm transition-all">
                        ✏️ Edit
                    </button>
                    <button onclick="deletePaste()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg text-sm transition-all">
                        🗑️ Delete
                    </button>
                    {% if current_user.is_admin and current_user.username != paste.author_username %}
                    <span class="text-xs text-yellow-400">(Admin)</span>
                    {% endif %}
                    {% endif %}
                    <button onclick="copyCode()" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm transition-all">
                        📋 Salin Kode
                    </button>
                    <button onclick="downloadCode()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm transition-all">
                        ⬇️ Unduh Kode
                    </button>
                    <button onclick="copyURL()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm transition-all">
                        🔗 Salin URL
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-900/80 rounded-lg p-4 overflow-x-auto">
                <pre><code id="pasteCode" class="language-{{ paste.language }}">{{ paste.content }}</code></pre>
            </div>
        </div>
        
        <div class="glass rounded-lg p-4 sm:p-6">
            <h3 class="text-xl font-semibold mb-4">💬 Discussion Thread</h3>
            
            <form id="threadForm" class="mb-6">
                <input type="hidden" name="paste_id" value="{{ paste.id }}">
                <textarea name="content" required placeholder="Add your comment..."
                          class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3 resize-none"
                          rows="3"></textarea>
                <button type="submit" class="btn-primary px-6 py-2 rounded-lg">
                    Post Comment
                </button>
            </form>
            
            <div id="threads" class="space-y-4">
                {% for thread in threads %}
                <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-start mb-2 space-y-1 sm:space-y-0">
                        <span class="font-medium text-blue-300 flex items-center gap-1">
                            {{ thread.author_username }}
                            <span class="text-blue-400">✓</span>
                        </span>
                        <span class="text-gray-400 text-sm">{{ thread.created_at[:19].replace('T', ' ') }}</span>
                    </div>
                    <p class="text-gray-200">{{ thread.content }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        function copyURL() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = document.querySelector('button[onclick="copyURL()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '✅ URL Tersalin!';
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy URL:', err);
                alert('Gagal menyalin URL. Silakan copy manual dari address bar.');
            });
        }

        function downloadCode() {
            const codeElement = document.getElementById('pasteCode');
            if (!codeElement) {
                alert('Kode tidak ditemukan');
                return;
            }
            const content = codeElement.textContent || codeElement.innerText;

            const lang = "{{ paste.language }}";
            const extensions = {
                python: 'py',
                javascript: 'js',
                typescript: 'ts',
                java: 'java',
                c: 'c',
                cpp: 'cpp',
                csharp: 'cs',
                ruby: 'rb',
                go: 'go',
                php: 'php',
                html: 'html',
                css: 'css',
                text: 'txt'
            };
            const ext = extensions[lang] || lang;
            const filename = "{{ (paste.title or 'code')|replace(' ', '_') }}." + ext;

            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        function copyCode() {
            const codeElement = document.getElementById('pasteCode');
            if (!codeElement) {
                alert('Kode tidak ditemukan');
                return;
            }
            
            const content = codeElement.textContent || codeElement.innerText;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(content).then(() => {
                    const btn = document.querySelector('button[onclick="copyCode()"]');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Tersalin!';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy code:', err);
                    fallbackCopyTextToClipboard(content);
                });
            } else {
                fallbackCopyTextToClipboard(content);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const btn = document.querySelector('button[onclick="copyCode()"]');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Tersalin!';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-green-500', 'hover:bg-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                } else {
                    alert('Gagal menyalin kode. Silakan copy manual.');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert('Gagal menyalin kode. Silakan copy manual.');
            }

            document.body.removeChild(textArea);
        }

        document.getElementById('threadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/thread', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to post comment');
                }
            } catch (error) {
                alert('Failed to post comment: ' + error.message);
            }
        });

        setInterval(async () => {
            try {
                const response = await fetch(`/api/paste/{{ paste.id }}/stats`);
                const data = await response.json();
                document.getElementById('view-count').textContent = data.views;
            } catch (error) {
                console.error('Failed to update view count:', error);
            }
        }, 30000);

        Prism.highlightAll();

        function editPaste() {
            window.location.href = `/edit/{{ paste.id }}`;
        }

        async function deletePaste() {
            if (!confirm('Apakah Anda yakin ingin menghapus paste ini? Tindakan ini tidak dapat dibatalkan.')) {
                return;
            }

            try {
                const response = await fetch(`/api/paste/{{ paste.id }}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    alert('Paste berhasil dihapus!');
                    window.location.href = '/dashboard';
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Gagal menghapus paste');
                }
            } catch (error) {
                alert('Gagal menghapus paste: ' + error.message);
            }
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (query) {
                window.location.href = `/?q=${encodeURIComponent(query)}`;
            }
        }

        // Allow Enter key to trigger search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        async function toggleFollow(username) {
            const btn = document.getElementById('followBtn');
            const text = document.getElementById('followText');
            const isFollowing = btn.dataset.following === 'true';
            
            try {
                const response = await fetch(`/api/follow/${username}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    btn.dataset.following = data.following ? 'true' : 'false';
                    text.textContent = data.following ? 'Unfollow' : 'Follow';
                    
                    // Update button style
                    if (data.following) {
                        btn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all hover:scale-105 focus:outline-none bg-gray-600 hover:bg-gray-700 text-white';
                    } else {
                        btn.className = 'px-3 py-1 rounded-lg text-xs font-medium transition-all hover:scale-105 focus:outline-none bg-blue-600 hover:bg-blue-700 text-white';
                    }
                } else {
                    alert('Error following/unfollowing user');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error following/unfollowing user');
            }
        }

        // Set initial follow button style
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('followBtn');
            if (btn) {
                btn.className += ' bg-blue-600 hover:bg-blue-700 text-white';
            }
        });
    </script>
</body>
</html>
